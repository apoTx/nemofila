app.controller("newEventController",["$scope","Upload","$timeout","$http","$window","newEventFactory","categoriesFactory",(e,t,n,a,o,r,s)=>{function i(){function e(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}return e()+e()+"-"+e()+"-"+e()+"-"+e()+"-"+e()+e()+e()}e.newEventForm={},e.steps={},e.steps.informations=!0,e.steps.preview=!1,e.newEventForm.place=null,$(()=>{const t={date:e=>e?e.getDate()+"/"+(e.getMonth()+1)+"/"+e.getFullYear():""},n=new Date,a={minDate:new Date(n.getFullYear(),n.getMonth(),n.getDate()),maxDate:new Date(n.getFullYear(),n.getMonth(),n.getDate()+60)},o={maxDate:new Date(n.getFullYear(),n.getMonth(),n.getDate()+30)};$("#startDate").calendar({type:"date",onChange:(t,n)=>{e.newEventForm.startDate=t,e.newEventForm.startDateText=n,e.$apply(),console.log(e.newEventForm.startDate),console.log(e.newEventForm.startDate-30)},formatter:{date:t.date},minDate:a.minDate,maxDate:a.maxDate,endCalendar:$("#endDate")}),$("#endDate").calendar({type:"date",onChange:(t,n)=>{e.newEventForm.endDate=t,e.newEventForm.endDateText=n},formatter:{date:t.date},maxDate:o.maxDate,startCalendar:$("#startDate")}),$("#newEventForm").form({keyboardShortcuts:!1,on:"blur",inline:!0,fields:{title:{identifier:"title",rules:[{type:"empty",prompt:"Please enter a title."},{type:"maxLength[100]",prompt:"Your title can be up to {ruleValue} characters long."}]},description:{identifier:"description",rules:[{type:"empty",prompt:"Please enter a description."},{type:"maxLength[2000]",prompt:"Your description can be up to {ruleValue} characters long."}]},category:{identifier:"category",rules:[{type:"empty",prompt:"Please select a category."}]},startDate:{identifier:"startDate",rules:[{type:"empty",prompt:"Please select a start date."}]},endDate:{identifier:"endDate",rules:[{type:"empty",prompt:"Please select a end date."}]}},onSuccess:()=>{e.next()}})}),e.init=(t=>{e.loadingAd=!0,r.getAd(t).then(t=>{e.loadingAd=!1,e.ad=t}),s.getEventCategories().then(t=>{e.eventCategories=t})}),e.next=(()=>{e.previewTab(),e.$apply()}),e.back=(()=>{e.adInformationTab()}),e.uploadedFiles=[],e.getAd=(t=>{e.loadingBufferData=!0,a({url:"/newAd/getEditAd/"+t,method:"GET"}).then(t=>{e.newEventForm.title=t.data.title||"",e.newEventForm.description=t.data.description||"",e.newEventForm.phone=t.data.phone||"",e.newEventForm.mobile_phone=t.data.mobile_phone||"",e.newEventForm.address=t.data.address||"",e.newEventForm.website=t.data.website||"",e.newEventForm.anotherContact=t.data.anotherContact,e.newEventForm.anotherContact||(e.newEventForm.anotherContact={},e.newEventForm.anotherContact.checked=!1);try{e.newEventForm.files=t.data.photos||"",e.uploadedFiles=e.newEventForm.files,e.newEventForm.showcaseIndex=t.data.photoShowcaseIndex}catch(t){e.newEventForm.files=[]}let n=t.data.location,a=t.data.category;setTimeout(()=>{e.newEventForm.category=e.categories.findIndex(e=>String(e._id)===String(a.categoryId)).toString(),e.newEventForm.categoryChild=e.categories[e.newEventForm.category].subCategories.findIndex(e=>String(e._id)===String(a.categoryChildId)).toString(),e.newEventForm.country=e.countries.findIndex(e=>String(e._id)===String(n.countryId)).toString(),e.newEventForm.city=e.countries[e.newEventForm.country].cities.findIndex(e=>String(e._id)===String(n.cityId)).toString(),e.newEventForm.district=e.countries[e.newEventForm.country].cities[e.newEventForm.city].districts.findIndex(e=>String(e._id)===String(n.districtId)).toString()}),e.loadingBufferData=!1},()=>{console.log("fail"),e.loadingBufferData=!1})}),e.uploadAndSaveMongo=(t=>{e.newEventForm.files&&e.newEventForm.files.length>0?e.uploadFiles(e.newEventForm.files,t):e.onSubmitAd(null,t,!1)}),e.nextLoader=!1,e.uploading=!1,e.photos=[];let l=0;e.uploadFiles=((n,a)=>{if(e.nextLoader=!0,e.uploading=!0,n&&n.length){let o=0;n.filter(e=>e.name).length<1&&(e.uploading=!1,e.onSubmitAd(n,a,!1)),n.forEach(r=>{let s=i()+"_"+r.name;if(!r.name)return l++,!0;r.upload=t.upload({url:"https://easyad-static.s3-eu-central-1.amazonaws.com",method:"POST",data:{key:s,acl:e.acl,policy:e.policy,"X-amz-signature":e.X_amz_signature,"X-amz-credential":e.x_amz_credential,"X-amz-algorithm":e.X_amz_algorithm,"X-amz-date":e.X_amz_date,"Content-Type":""!=r.type?r.type:"application/octet-stream",filename:r.name,file:r}}),r.upload.then(t=>{e.result=t.data,r.progressFinish=!0,o++,r.showcase?e.photos.push({filename:s,showcase:!0}):e.photos.push({filename:s}),o+l===n.length&&(e.uploading=!1,e.onSubmitAd(e.photos,a))},t=>{t.status>0&&(e.errorMsg=t.status+": "+t.data)},e=>{r.progress=Math.min(100,parseInt(100*e.loaded/e.total))})})}}),e.eventSaveComplete=!1,e.submitBtnLoading=!1,e.onSubmitAd=((t,n,r)=>{e.submitBtnLoading=!0;let s=Object.assign({},e.newEventForm);delete s.files;let i;!1===r?i=t:e.uploadedFiles?(console.log("test"),i=t?t.concat(e.uploadedFiles):null):i=t;let l;try{l=i.findIndex(e=>!0===e.showcase)}catch(e){l=null}s.eventCategory=e.eventCategories[e.newEventForm.eventCategory]._id,console.log(s.eventCategory);let d="false"!==n;a({url:"/events/new",method:"POST",data:{recaptcha:document.getElementById("g-recaptcha-response").value,data:s,isEdit:d,adId:n,power:{powerStatus:e.buyPowerStatus,powerNumber:e.powerNumber},photos:i,showcaseIndex:l}}).then(t=>{e.submitBtnLoading=!1,1===t.data.status&&(e.eventSaveComplete=!0,o.scrollTo(0,0))},()=>{e.submitBtnLoading=!1,console.log("fail")})}),e.newEventForm.showcaseIndex=0,e.onPhotoSelect=(()=>{e.isEdit?e.uploadedFiles<1&&(e.newEventForm.files[0].showcase=!0):e.newEventForm.files.length>0&&(e.newEventForm.files[e.newEventForm.showcaseIndex].showcase=!0)}),e.onDeletePhoto=(t=>{e.newEventForm.files.splice(t,1),e.newEventForm.showcaseIndex===t&&(e.newEventForm.files[0].showcase=!0,e.newEventForm.showcaseIndex=0)}),e.onSelectShowCase=(t=>{e.newEventForm.files[e.newEventForm.showcaseIndex].showcase=!1,e.newEventForm.showcaseIndex=t,e.newEventForm.files[t].showcase=!0}),e.triggerUploadWindow=(()=>{$('input[type="file"]').trigger("click")}),e.previewTab=(()=>{e.steps.informations=!1,e.steps.power=!1,e.steps.preview=!0,o.scrollTo(0,0)}),e.powerTab=(()=>{e.steps.informations=!1,e.steps.power=!0,e.steps.preview=!1,o.scrollTo(0,0)}),e.adInformationTab=(()=>{e.steps.informations=!0,e.steps.power=!1,e.steps.preview=!1,o.scrollTo(0,0)}),e.activeSaveBtn=!1,e.successCaptcha=(()=>{e.activeSaveBtn=!0})}]);