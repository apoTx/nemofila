app.controller("newAdController",["$scope","Upload","$timeout","$http",(e,o,t,a)=>{e.newAdForm={},e.newAdForm.anotherContact={},e.steps={},e.steps.informations=!0,e.steps.preview=!1,$(()=>{$("#newAdForm").form(),$(".ui.checkbox").checkbox({onChecked:()=>{e.newAdForm.anotherContact.checked=!0,setTimeout(()=>{$('input[name="anotherContactName"]').focus()},20)},onUnchecked:()=>{e.newAdForm.anotherContact.checked=!1},onChange:()=>{e.$apply()}})}),e.init=(o=>{"false"!==o&&e.getAdBuffer(o)}),e.getAdBuffer=(o=>{e.loadingBufferData=!0,a({url:"/newAd/getAdBuffer/"+o,method:"GET"}).then(o=>{e.newAdForm.title=o.data.title||"",e.newAdForm.description=o.data.description||"",e.newAdForm.price=o.data.price||"",e.newAdForm.anotherContact=JSON.parse(o.data.anotherContact);try{e.newAdForm.files=JSON.parse(o.data.photos)||""}catch(o){e.newAdForm.files={}}e.loadingBufferData=!1},()=>{console.log("fail"),e.loadingBufferData=!1})}),e.uploadAndSaveRedis=(()=>{e.newAdForm.files?e.uploadFiles(e.newAdForm.files,!0):e.saveAdToRedis(null,null)}),e.uploadAndSaveMongo=(o=>{e.newAdForm.files?e.uploadFiles(e.newAdForm.files,!1,o):e.onSubmitAd(null,null)}),e.nextLoader=!1,e.uploading=!1,e.uploadFiles=((t,a,n)=>{e.nextLoader=!0,e.uploading=!0,t&&t.length&&o.upload({url:"newAd/uploadPhotos/"+e.newAdForm.showcaseIndex+"/"+n,method:"POST",file:t}).then(o=>{e.result=o.data,e.uploading=!1,1===o.data.status&&(a?e.saveAdToRedis(o.data.uuid,o.data.photos):e.onSubmitAd(o.data.uuid,o.data.photos))},o=>{o.status>0&&(e.errorMsg=o.status+": "+o.data)},o=>{e.progress=Math.min(100,parseInt(100*o.loaded/o.total))})}),e.saveAdToRedis=((o,t)=>{e.newAdBtnLoading=!0;var d;d=null!==o?{data:e.newAdForm,uuid:o,photos:t}:{data:e.newAdForm},a({url:"/newAd/saveAdRedis",method:"POST",data:d}).then(o=>{e.newAdBtnLoading=!1,1===o.data.status&&n()},()=>{console.log("fail")})}),e.adSaveComplete=!1,e.submitBtnLoading=!1,e.onSubmitAd=((o,t)=>{e.submitBtnLoading=!0;let n=Object.assign({},e.newAdForm);delete n.files,a({url:"/newAd/create",method:"POST",data:{data:n,photos:t,uuid:o}}).then(o=>{e.submitBtnLoading=!1,1===o.data.status&&(e.adSaveComplete=!0)},()=>{e.submitBtnLoading=!1,console.log("fail")})}),e.newAdForm.showcaseIndex=0,e.onPhotoSelect=(()=>{e.newAdForm.files.length>0&&(e.newAdForm.files[e.newAdForm.showcaseIndex].showcase=!0)}),e.onDeletePhoto=(o=>{e.newAdForm.files.splice(o,1),e.newAdForm.files.length>0&&(e.newAdForm.files[0].showcase=!0,e.newAdForm.showcaseIndex=0)}),e.onSelectShowCase=(o=>{e.newAdForm.files[e.newAdForm.showcaseIndex].showcase=!1,e.newAdForm.showcaseIndex=o,e.newAdForm.files[o].showcase=!0}),e.triggerUploadWindow=(()=>{$('input[type="file"]').trigger("click")});let n=()=>{e.openSignInModal(),e.previewTab(),e.nextLoader=!1};e.previewTab=(()=>{e.steps.informations=!1,e.steps.preview=!0}),e.adInformationTab=(()=>{e.steps.informations=!0,e.steps.preview=!1})}]);