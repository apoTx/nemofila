app.controller("newAdController",["$scope","Upload","$timeout","$http","$window","countriesFactory","categoriesFactory",(e,o,t,n,d,a,r)=>{function i(){function e(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}return e()+e()+"-"+e()+"-"+e()+"-"+e()+"-"+e()+e()+e()}e.newAdForm={},e.newAdForm.anotherContact={},e.steps={},e.steps.informations=!0,e.steps.preview=!1,$(()=>{$("#newAdForm").form({keyboardShortcuts:!1,on:"blur",inline:!0,onSuccess:()=>{e.next()}}),$(".ui.checkbox").checkbox({onChecked:()=>{e.newAdForm.anotherContact.checked=!0,setTimeout(()=>{$('input[name="anotherContactName"]').focus()},20)},onUnchecked:()=>{e.newAdForm.anotherContact.checked=!1},onChange:()=>{e.$apply()}})}),e.init=((o,t)=>{"false"!==o&&e.getAdBuffer(o),e.userExists="true"==t,a.getCountries().then(o=>{e.countries=o}),r.getCategories().then(o=>{e.categories=o})}),e.next=(()=>{console.log("next"),e.userExists?(console.log("previewTab()"),e.previewTab()):(console.log("uploadAndSaveRedis()"),e.uploadAndSaveRedis()),e.$apply()});let s=[];e.getAdBuffer=(o=>{e.loadingBufferData=!0,n({url:"/newAd/getAdBuffer/"+o,method:"GET"}).then(o=>{e.newAdForm.title=o.data.title||"",e.newAdForm.description=o.data.description||"",e.newAdForm.price=o.data.price||"",e.newAdForm.anotherContact=JSON.parse(o.data.anotherContact);try{e.newAdForm.files=JSON.parse(o.data.photos)||"",s=e.newAdForm.files}catch(o){e.newAdForm.files=[]}let t=JSON.parse(o.data.country);e.newAdForm.country=t.country.index,e.newAdForm.city=t.city.index,e.newAdForm.district=t.district.index;let n=JSON.parse(o.data.category);e.newAdForm.category=n.category.index,e.newAdForm.categoryChild=n.childCategory.index,e.loadingBufferData=!1},()=>{console.log("fail"),e.loadingBufferData=!1})}),e.uploadAndSaveRedis=(()=>{e.newAdForm.files&&e.newAdForm.files.length>0?e.uploadFiles(e.newAdForm.files,!0):e.saveAdToRedis(null,null)}),e.uploadAndSaveMongo=(o=>{e.newAdForm.files&&e.newAdForm.files.length>0?e.uploadFiles(e.newAdForm.files,!1,o):e.onSubmitAd(null,null)}),e.nextLoader=!1,e.uploading=!1,e.uploadFiles=((t,n)=>{if(e.nextLoader=!0,e.uploading=!0,t&&t.length){let d=0,a=[];angular.forEach(t,r=>{let s=i()+"_"+r.name;r.upload=o.upload({url:"https://easyad-static.s3-eu-central-1.amazonaws.com",method:"POST",data:{key:s,acl:e.acl,policy:e.policy,"X-amz-signature":e.X_amz_signature,"X-amz-credential":e.x_amz_credential,"X-amz-algorithm":e.X_amz_algorithm,"X-amz-date":e.X_amz_date,"Content-Type":""!=r.type?r.type:"application/octet-stream",filename:r.name,file:r}}),r.upload.then(o=>{e.result=o.data,r.progressFinish=!0,d++,a.push({filename:s}),d===t.length&&(e.uploading=!1,n?e.saveAdToRedis(o.data.uuid,o.data.photos):e.onSubmitAd(o.data.uuid,a))},o=>{o.status>0&&(e.errorMsg=o.status+": "+o.data)},e=>{r.progress=Math.min(100,parseInt(100*e.loaded/e.total))})})}}),e.saveAdToRedis=((o,t)=>{e.newAdBtnLoading=!0;var d;d=null!==o?{data:e.newAdForm,uuid:o,photos:t}:{data:e.newAdForm},n({url:"/newAd/saveAdRedis",method:"POST",data:{data:d,country:{country:{id:e.countries[e.newAdForm.country]._id,index:e.newAdForm.country},city:{id:e.countries[e.newAdForm.country].cities[e.newAdForm.city]._id,index:e.newAdForm.city},district:{id:e.countries[e.newAdForm.country].cities[e.newAdForm.city].districts[e.newAdForm.district]._id,index:e.newAdForm.district}},category:{category:{id:e.categories[e.newAdForm.category]._id,index:e.newAdForm.category},childCategory:{id:e.categories[e.newAdForm.category].subCategories[e.newAdForm.categoryChild]._id,index:e.newAdForm.categoryChild}}}}).then(o=>{e.newAdBtnLoading=!1,1===o.data.status&&c()},()=>{console.log("fail")})}),e.adSaveComplete=!1,e.submitBtnLoading=!1,e.onSubmitAd=((o,t)=>{e.submitBtnLoading=!0;let a=Object.assign({},e.newAdForm);delete a.files;let r=t?t.concat(s):null;n({url:"/newAd/create",method:"POST",data:{data:a,photos:r,uuid:o,showcaseIndex:e.newAdForm.showcaseIndex,country:{countryId:e.countries[e.newAdForm.country]._id,cityId:e.countries[e.newAdForm.country].cities[e.newAdForm.city]._id,districtId:e.countries[e.newAdForm.country].cities[e.newAdForm.city].districts[e.newAdForm.district]._id},category:{categoryId:e.categories[e.newAdForm.category]._id,childCategoryId:e.categories[e.newAdForm.category].subCategories[e.newAdForm.categoryChild]._id}}}).then(o=>{e.submitBtnLoading=!1,1===o.data.status&&(e.adSaveComplete=!0,d.scrollTo(0,0))},()=>{e.submitBtnLoading=!1,console.log("fail")})}),e.newAdForm.showcaseIndex=0,e.onPhotoSelect=(()=>{e.newAdForm.files.length>0&&(e.newAdForm.files[e.newAdForm.showcaseIndex].showcase=!0)}),e.onDeletePhoto=(o=>{e.newAdForm.files.splice(o,1),e.newAdForm.showcaseIndex===o&&(e.newAdForm.files[0].showcase=!0,e.newAdForm.showcaseIndex=0)}),e.onSelectShowCase=(o=>{e.newAdForm.files[e.newAdForm.showcaseIndex].showcase=!1,e.newAdForm.showcaseIndex=o,e.newAdForm.files[o].showcase=!0}),e.triggerUploadWindow=(()=>{$('input[type="file"]').trigger("click")});let c=()=>{e.openSignInModal(),e.previewTab(),e.nextLoader=!1};e.previewTab=(()=>{e.steps.informations=!1,e.steps.preview=!0}),e.adInformationTab=(()=>{e.steps.informations=!0,e.steps.preview=!1})}]);