app.controller("newAdController",["$scope","Upload","$timeout","$http","$window","countriesFactory","categoriesFactory",(e,t,o,r,n,d,i)=>{e.newAdForm={},e.newAdForm.anotherContact={},e.steps={},e.steps.informations=!0,e.steps.preview=!1,$(()=>{$("#newAdForm").form({on:"blur",inline:!0,fields:{title:{identifier:"title",rules:[{type:"empty",prompt:"Please enter a title."},{type:"maxLength[100]",prompt:"Your title can be up to {ruleValue} characters long."}]},price:{identifier:"price",rules:[{type:"empty",prompt:"Please enter a price."},{type:"decimal",prompt:"Please enter a valid price."}]},description:{identifier:"description",rules:[{type:"empty",prompt:"Please enter a description."},{type:"maxLength[2000]",prompt:"Your description can be up to {ruleValue} characters long."}]},country:{identifier:"country",rules:[{type:"empty",prompt:"Please select a country."}]},city:{identifier:"city",rules:[{type:"empty",prompt:"Please select a city."}]},district:{identifier:"district",rules:[{type:"empty",prompt:"Please select a district."}]},category:{identifier:"category",rules:[{type:"empty",prompt:"Please select a category."}]},subCategory:{identifier:"subCategory",rules:[{type:"empty",prompt:"Please select a sub category."}]}},onSuccess:()=>{e.next()}}),$(".ui.checkbox").checkbox({onChecked:()=>{e.newAdForm.anotherContact.checked=!0,setTimeout(()=>{$('input[name="anotherContactName"]').focus()},20)},onUnchecked:()=>{e.newAdForm.anotherContact.checked=!1},onChange:()=>{e.$apply()}})}),e.init=((t,o)=>{"false"!==t&&e.getAdBuffer(t),e.userExists="true"==o,d.getCountries().then(t=>{e.countries=t}),i.getCategories().then(t=>{e.categories=t})}),e.next=(()=>{console.log("next"),e.userExists?(console.log("previewTab()"),e.previewTab()):(console.log("uploadAndSaveRedis()"),e.uploadAndSaveRedis()),e.$apply()});let a=[];e.getAdBuffer=(t=>{e.loadingBufferData=!0,r({url:"/newAd/getAdBuffer/"+t,method:"GET"}).then(t=>{e.newAdForm.title=t.data.title||"",e.newAdForm.description=t.data.description||"",e.newAdForm.price=t.data.price||"",e.newAdForm.anotherContact=JSON.parse(t.data.anotherContact);try{e.newAdForm.files=JSON.parse(t.data.photos)||"",a=e.newAdForm.files}catch(t){e.newAdForm.files=[]}let o=JSON.parse(t.data.country);e.newAdForm.country=o.country.index,e.newAdForm.city=o.city.index,e.newAdForm.district=o.district.index;let r=JSON.parse(t.data.category);e.newAdForm.category=r.category.index,e.newAdForm.categoryChild=r.childCategory.index,e.loadingBufferData=!1},()=>{console.log("fail"),e.loadingBufferData=!1})}),e.uploadAndSaveRedis=(()=>{e.newAdForm.files&&e.newAdForm.files.length>0?e.uploadFiles(e.newAdForm.files,!0):e.saveAdToRedis(null,null)}),e.uploadAndSaveMongo=(t=>{e.newAdForm.files&&e.newAdForm.files.length>0?e.uploadFiles(e.newAdForm.files,!1,t):e.onSubmitAd(null,null)}),e.nextLoader=!1,e.uploading=!1,e.uploadFiles=((o,r,n)=>{e.nextLoader=!0,e.uploading=!0,o&&o.length&&t.upload({url:"newAd/uploadPhotos/"+e.newAdForm.showcaseIndex+"/"+n,method:"POST",file:o}).then(t=>{e.result=t.data,e.uploading=!1,1===t.data.status&&(r?e.saveAdToRedis(t.data.uuid,t.data.photos):e.onSubmitAd(t.data.uuid,t.data.photos))},t=>{t.status>0&&(e.errorMsg=t.status+": "+t.data)},t=>{e.progress=Math.min(100,parseInt(100*t.loaded/t.total))})}),e.saveAdToRedis=((t,o)=>{e.newAdBtnLoading=!0;var n;n=null!==t?{data:e.newAdForm,uuid:t,photos:o}:{data:e.newAdForm},r({url:"/newAd/saveAdRedis",method:"POST",data:{data:n,country:{country:{id:e.countries[e.newAdForm.country]._id,index:e.newAdForm.country},city:{id:e.countries[e.newAdForm.country].cities[e.newAdForm.city]._id,index:e.newAdForm.city},district:{id:e.countries[e.newAdForm.country].cities[e.newAdForm.city].districts[e.newAdForm.district]._id,index:e.newAdForm.district}},category:{category:{id:e.categories[e.newAdForm.category]._id,index:e.newAdForm.category},childCategory:{id:e.categories[e.newAdForm.category].subCategories[e.newAdForm.categoryChild]._id,index:e.newAdForm.categoryChild}}}}).then(t=>{e.newAdBtnLoading=!1,1===t.data.status&&s()},()=>{console.log("fail")})}),e.adSaveComplete=!1,e.submitBtnLoading=!1,e.onSubmitAd=((t,o)=>{e.submitBtnLoading=!0;let d=Object.assign({},e.newAdForm);delete d.files;let i,s=o?o.concat(a):null;i=null!==s?s.findIndex(e=>!0===e.showcase):null,r({url:"/newAd/create",method:"POST",data:{data:d,photos:s,uuid:t,showcaseIndex:i,country:{countryId:e.countries[e.newAdForm.country]._id,cityId:e.countries[e.newAdForm.country].cities[e.newAdForm.city]._id,districtId:e.countries[e.newAdForm.country].cities[e.newAdForm.city].districts[e.newAdForm.district]._id},category:{categoryId:e.categories[e.newAdForm.category]._id,childCategoryId:e.categories[e.newAdForm.category].subCategories[e.newAdForm.categoryChild]._id}}}).then(t=>{e.submitBtnLoading=!1,1===t.data.status&&(e.adSaveComplete=!0,n.scrollTo(0,0))},()=>{e.submitBtnLoading=!1,console.log("fail")})}),e.newAdForm.showcaseIndex=0,e.onPhotoSelect=(()=>{e.newAdForm.files.length>0&&(e.newAdForm.files[e.newAdForm.showcaseIndex].showcase=!0)}),e.onDeletePhoto=(t=>{e.newAdForm.files.splice(t,1),e.newAdForm.showcaseIndex===t&&(e.newAdForm.files[0].showcase=!0,e.newAdForm.showcaseIndex=0)}),e.onSelectShowCase=(t=>{e.newAdForm.files[e.newAdForm.showcaseIndex].showcase=!1,e.newAdForm.showcaseIndex=t,e.newAdForm.files[t].showcase=!0}),e.triggerUploadWindow=(()=>{$('input[type="file"]').trigger("click")});let s=()=>{e.openSignInModal(),e.previewTab(),e.nextLoader=!1};e.previewTab=(()=>{e.steps.informations=!1,e.steps.preview=!0}),e.adInformationTab=(()=>{e.steps.informations=!0,e.steps.preview=!1})}]);