app.controller("newAdController",["$scope","Upload","$timeout","$http","$window","newAdFactory","countriesFactory","categoriesFactory","config","Slug",(e,t,o,a,n,r,s,i,l,d)=>{function c(t,o,a,n,s,i,l=!0,d=!1){try{let d,c;if(o)d=o.lat,c=o.lng;else try{d=t.coords.latitude,c=t.coords.longitude}catch(e){d=s,c=i}e.latLng={lat:d,lng:c};const p=new google.maps.LatLng(d,c),m={zoom:a||15,center:p,mapTypeId:google.maps.MapTypeId.ROADMAP},g=new google.maps.Map(document.getElementById(n||"map"),m),u=new google.maps.Marker({position:p,map:g,draggable:l,title:"Drag me!"});setTimeout(()=>{e.mapLoading=!1,e.$apply()}),google.maps.event.addListener(u,"dragend",t=>{const o=t.latLng.lat(),a=t.latLng.lng();e.latLng={lat:o,lng:a},new google.maps.places.PlacesService(g).getDetails({placeId:"ChIJI0nDBVxO0xQRC3xd41VI_7I"},(e,t)=>{t===google.maps.places.PlacesServiceStatus.OK&&(console.log("asdas"),console.log(e))}),r.getLocationDetail(o,a).then(t=>{const o=t.results.findIndex(e=>"administrative_area_level_1"==e.types[0]),a=t.results[o].formatted_address,n=t.results[0];n.formatted_address=a,e.newAdForm.place=n})})}catch(e){console.log(e)}}function p(){alert("navigator.geolocation failed, may not be supported"),e.mapLoading=!1}function m(){function e(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}return e()+e()+"-"+e()+"-"+e()+"-"+e()+"-"+e()+e()+e()}e.mapLoading=!1,e.locate=(()=>{e.mapLoading=!0,navigator.geolocation.getCurrentPosition(c,p)}),e.latLng,e.$watch("newAdForm.place",t=>{if("object"==typeof t)try{const o={lat:t.geometry.location.lat(),lng:t.geometry.location.lng()};e.latLng=o,c(0,o,12,"map",!1,!1,!0)}catch(e){}}),e.newAdForm={},e.newAdForm.anotherContact={},e.steps={},e.steps.informations=!0,e.steps.power=!1,e.steps.preview=!1,e.powerNumber="0",e.buyPowerStatus=!1,e.buyPowerLoader=!1,e.newAdForm.place=null,e.autocompleteOptions={types:["(cities)"]},$(()=>{function t(t){e.buyPowerLoader=!0,e.$apply(),fetch("/charge",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(Object.assign(t,{amount:parseInt(e.powerNumber)}))}).then(t=>{"OK"===t.statusText&&(e.buyPowerStatus=!0,e.buyPowerLoader=!1,e.$apply())})}$("#buttonCheckout").on("click",()=>{e.powerNumber=e.powerNumber.split(":")[1],parseInt(e.powerNumber)>0&&checkoutHandler.open({name:"Easyad",description:"Power Purchase",token:t})}),$(".powerNumber").on("change",()=>{e.powerNumber=$(".powerNumber").val()}),$("#newAdForm").form({keyboardShortcuts:!1,on:"blur",inline:!0,fields:{title:{identifier:"title",rules:[{type:"empty",prompt:"Please enter a title."},{type:"maxLength[100]",prompt:"Your title can be up to {ruleValue} characters long."}]},mobile_phone:{identifier:"mobile_phone",rules:[{type:"empty",prompt:"Please enter a mobile phone."}]},description:{identifier:"description",rules:[{type:"empty",prompt:"Please enter a description."},{type:"maxLength[2000]",prompt:"Your description can be up to {ruleValue} characters long."}]},description2:{identifier:"description2",rules:[{type:"empty",prompt:"Please enter a description2."},{type:"maxLength[2000]",prompt:"Your description2 can be up to {ruleValue} characters long."}]},country:{identifier:"country",rules:[{type:"empty",prompt:"Please select a country."}]},city:{identifier:"city",rules:[{type:"empty",prompt:"Please select a city."}]},category:{identifier:"category",rules:[{type:"empty",prompt:"Please select a category."}]},website:{identifier:"website",optional:!0,rules:[{type:"url",prompt:"Please enter a valid URL"}]}},onSuccess:()=>{"object"==typeof e.newAdForm.place&&e.newAdForm.place?e.next():alert("Please select a location.")}}),$("#terms").on("click",()=>{$("#termsModal").modal("show")}),$("#workTimesBtn").on("click",()=>{$("#workTimesModal").modal("show")}),$(".hour24").change(function(){let e=$(this).parent("div").parent("div").next("div").children(".dropdowns");this.checked?e.addClass("timeDropdownsVisible"):e.removeClass("timeDropdownsVisible")}),$(".openClose").change(function(){let e=$(this).parent("div").parent("div").next("div");this.checked?e.removeClass("workTimeSettingsDisplay"):e.addClass("workTimeSettingsDisplay")}),$("#anotherPerson").checkbox({onChecked:()=>{e.newAdForm.anotherContact.checked=!0,setTimeout(()=>{$('input[name="anotherContactName"]').focus()},20)},onUnchecked:()=>{e.newAdForm.anotherContact.checked=!1},onChange:()=>{e.$apply()}})}),e.init=((t,o)=>{"false"!==t&&(e.getAd(t,()=>{c(0,!1,12,"map",e.newAdForm.place.geometry.location.lat,e.newAdForm.place.geometry.location.lng),e.latLng={lat:e.newAdForm.place.geometry.location.lat,lng:e.newAdForm.place.geometry.location.lng}}),e.isEdit=!0),e.userExists="true"==o,e.userExists||e.openSignInModal(),i.getCategories().then(t=>{e.categories=t}),e.clocks=["00:00","00:30","01:00","01:30","02:00","02:30","03:00","03:30","04:00","04:30","05:00","05:30","06:00","06:30","07:00","07:30","08:00","08:30","09:00","09:30","10:00","10:30","11:00","11:30","12:00","12:30","13:00","13:30","14:00","14:30","15:00","15:30","16:00","16:30","17:00","17:30","18:00","18:30","19:00","19:30","20:00","20:30","21:00","21:30","22:00","22:30","23:00","23:30"],e.newAdForm.workTimes={monday:{open:!1},tuesday:{open:!1},wednesday:{open:!1},thursday:{open:!1},friday:{open:!1},saturday:{open:!1},sunday:{open:!1}}}),e.filterWorkTime=(e=>(function(t){return t>e})),e.next=(()=>{e.previewTab(),e.$apply()}),e.back=(()=>{e.adInformationTab()}),e.uploadedFiles=[],e.getAd=((t,o)=>{e.loadingBufferData=!0,a({url:"/newAd/getEditAd/"+t,method:"GET"}).then(t=>{e.newAdForm.title=t.data.title||"",e.newAdForm.description=t.data.description||"",e.newAdForm.description2=t.data.description2||"",e.newAdForm.phone=t.data.phone||"",e.newAdForm.mobile_phone=t.data.mobile_phone||"",e.newAdForm.address=t.data.address||"",e.newAdForm.website=t.data.website||"",e.newAdForm.anotherContact=t.data.anotherContact,e.newAdForm.place=t.data.place,e.newAdForm.workTimes=t.data.workTimes,e.newAdForm.anotherContact||(e.newAdForm.anotherContact={},e.newAdForm.anotherContact.checked=!1);try{e.newAdForm.files=t.data.photos||"",e.uploadedFiles=e.newAdForm.files,e.newAdForm.showcaseIndex=t.data.photoShowcaseIndex}catch(t){e.newAdForm.files=[]}let a=t.data.category;setTimeout(()=>{e.newAdForm.category=e.categories.findIndex(e=>String(e._id)===String(a.categoryId)).toString(),e.newAdForm.categoryChild=e.categories[e.newAdForm.category].subCategories.findIndex(e=>String(e._id)===String(a.categoryChildId)).toString()}),e.loadingBufferData=!1,o()},()=>{console.log("fail"),e.loadingBufferData=!1})}),e.uploadAndSaveMongo=(t=>{e.newAdForm.files&&e.newAdForm.files.length>0?e.uploadFiles(e.newAdForm.files,t):e.onSubmitAd(null,t,!1)}),e.nextLoader=!1,e.uploading=!1,e.photos=[];let g=0;e.uploadFiles=((o,a)=>{if(e.nextLoader=!0,e.uploading=!0,o&&o.length){let n=0;o.filter(e=>e.name).length<1&&(e.uploading=!1,e.onSubmitAd(o,a,!1)),o.forEach((r,s)=>{let i=d.slugify(e.newAdForm.title),c=d.slugify(e.newAdForm.place.formatted_address),p=e.categories[e.newAdForm.category],u=d.slugify(p.name),w="";try{w=d.slugify(p.subCategories[e.newAdForm.categoryChild].name)}catch(e){}let h=r.name.split("."),y=h[h.length-1],f=(s+1)%3,A="",F="";if(1===f?(A=i+"-"+c+"-"+m()+"."+y,F=i+","+c+" - nemofila"):2===f?(A=u+"-"+c+"-"+m()+"."+y,F=i+","+u+","+c):(A=w+"-"+u+"-"+c+"-"+m()+"."+y,F=i+","+u+","+c),!r.name)return g++,!0;r.upload=t.upload({url:l.s3_upload_url,method:"POST",data:{key:A,acl:e.acl,policy:e.policy,"X-amz-signature":e.X_amz_signature,"X-amz-credential":e.x_amz_credential,"X-amz-algorithm":e.X_amz_algorithm,"X-amz-date":e.X_amz_date,"Content-Type":""!=r.type?r.type:"application/octet-stream",filename:A,file:r}}),r.upload.then(t=>{e.result=t.data,r.progressFinish=!0,n++,r.showcase?e.photos.push({filename:A,showcase:!0,altTag:F}):e.photos.push({filename:A,altTag:F}),n+g===o.length&&(e.uploading=!1,e.onSubmitAd(e.photos,a))},t=>{t.status>0&&(e.errorMsg=t.status+": "+t.data)},e=>{r.progress=Math.min(100,parseInt(100*e.loaded/e.total))})})}}),e.adSaveComplete=!1,e.submitBtnLoading=!1,e.onSubmitAd=((t,o,r)=>{e.submitBtnLoading=!0;let s=Object.assign({},e.newAdForm);delete s.files;let i;!1===r?i=t:e.uploadedFiles?(console.log("test"),i=t?t.concat(e.uploadedFiles):null):i=t;let l;try{l=i.findIndex(e=>!0===e.showcase)}catch(e){l=null}let d;try{d=e.categories[e.newAdForm.category].subCategories[e.newAdForm.categoryChild]._id}catch(e){d=null}let c="false"!==o;a({url:"/newAd/create",method:"POST",data:{recaptcha:document.getElementById("g-recaptcha-response").value,data:s,isEdit:c,editId:o,power:{powerStatus:e.buyPowerStatus,powerNumber:e.powerNumber},photos:i,showcaseIndex:l,category:{categoryId:e.categories[e.newAdForm.category]._id,childCategoryId:d}}}).then(t=>{e.submitBtnLoading=!1,1===t.data.status&&(e.adSaveComplete=!0,n.scrollTo(0,0))},()=>{e.submitBtnLoading=!1,console.log("fail")})}),e.newAdForm.showcaseIndex=0,e.onPhotoSelect=(()=>{e.isEdit?e.uploadedFiles<1&&(e.newAdForm.files[0].showcase=!0):e.newAdForm.files.length>0&&(e.newAdForm.files[e.newAdForm.showcaseIndex].showcase=!0)}),e.onDeletePhoto=(t=>{e.newAdForm.files.splice(t,1),e.newAdForm.showcaseIndex===t&&(e.newAdForm.files[0].showcase=!0,e.newAdForm.showcaseIndex=0)}),e.onSelectShowCase=(t=>{e.newAdForm.files[e.newAdForm.showcaseIndex].showcase=!1,e.newAdForm.showcaseIndex=t,e.newAdForm.files[t].showcase=!0}),e.triggerUploadWindow=(()=>{$('input[type="file"]').trigger("click")}),e.previewTab=(()=>{c(0,e.latLng,12,"mapPreview",!1,!1,!1,!1),e.steps.informations=!1,e.steps.power=!1,e.steps.preview=!0,n.scrollTo(0,0)}),e.powerTab=(()=>{e.steps.informations=!1,e.steps.power=!0,e.steps.preview=!1,n.scrollTo(0,0)}),e.adInformationTab=(()=>{e.steps.informations=!0,e.steps.power=!1,e.steps.preview=!1,n.scrollTo(0,0)}),e.activeSaveBtn=!1,e.successCaptcha=(()=>{e.activeSaveBtn=!0})}]);