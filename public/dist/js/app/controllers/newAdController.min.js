app.controller("newAdController",["$scope","Upload","$timeout","$http","$window","countriesFactory","categoriesFactory",(e,t,o,r,n,a,i)=>{function s(){function e(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}return e()+e()+"-"+e()+"-"+e()+"-"+e()+"-"+e()+e()+e()}e.newAdForm={},e.newAdForm.anotherContact={},e.steps={},e.steps.informations=!0,e.steps.power=!1,e.steps.preview=!1,e.powerList=["1","2","3"],e.powerNumber="0",e.buyPowerStatus=!1,e.buyPowerLoader=!1,e.updatePowerNumber=(t=>{e.powerNumber=t}),$(()=>{function t(t){console.log("test"),e.buyPowerLoader=!0,e.$apply(),fetch("/charge",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(Object.assign(t,{amount:parseInt(e.powerNumber)}))}).then(t=>{console.log(t),"OK"===t.statusText&&(e.buyPowerStatus=!0,e.buyPowerLoader=!1,e.$apply())})}let o=StripeCheckout.configure({key:"pk_test_1JpsNdtqXNvY0n3aKdDZxYap",locale:"auto"});$("#buttonCheckout").on("click",()=>{parseInt(e.powerNumber)>0&&o.open({name:"Easyad",description:"Power Purchase",token:t})}),$(".powerNumber").on("change",()=>{e.powerNumber=$(".powerNumber").val()}),$("#newAdForm").form({keyboardShortcuts:!1,on:"blur",inline:!0,fields:{title:{identifier:"title",rules:[{type:"empty",prompt:"Please enter a title."},{type:"maxLength[100]",prompt:"Your title can be up to {ruleValue} characters long."}]},price:{identifier:"price",rules:[{type:"empty",prompt:"Please enter a price."},{type:"decimal",prompt:"Please enter a valid price."}]},description:{identifier:"description",rules:[{type:"empty",prompt:"Please enter a description."},{type:"maxLength[2000]",prompt:"Your description can be up to {ruleValue} characters long."}]},country:{identifier:"country",rules:[{type:"empty",prompt:"Please select a country."}]},city:{identifier:"city",rules:[{type:"empty",prompt:"Please select a city."}]},category:{identifier:"category",rules:[{type:"empty",prompt:"Please select a category."}]}},onSuccess:()=>{e.next()}}),$(".ui.checkbox").checkbox({onChecked:()=>{e.newAdForm.anotherContact.checked=!0,setTimeout(()=>{$('input[name="anotherContactName"]').focus()},20)},onUnchecked:()=>{e.newAdForm.anotherContact.checked=!1},onChange:()=>{e.$apply()}})}),e.init=((t,o)=>{"false"!==t&&e.getAd(t),e.userExists="true"==o,a.getCountries().then(t=>{e.countries=t}),i.getCategories().then(t=>{e.categories=t})}),e.next=(()=>{e.powerTab(),e.$apply()});let d=[];e.getAd=(t=>{e.loadingBufferData=!0,r({url:"/newAd/getEditAd/"+t,method:"GET"}).then(t=>{e.newAdForm.title=t.data.title||"",e.newAdForm.description=t.data.description||"",e.newAdForm.price=t.data.price||"",e.newAdForm.anotherContact=t.data.anotherContact;try{e.newAdForm.files=t.data.photos||"",d=e.newAdForm.files,console.log(e.newAdForm.files)}catch(t){e.newAdForm.files=[]}let o=t.data.category;setTimeout(()=>{e.newAdForm.category=e.categories.findIndex(e=>String(e._id)===String(o.categoryId)).toString(),e.newAdForm.categoryChild=e.categories[e.newAdForm.category].subCategories.findIndex(e=>String(e._id)===String(o.categoryChildId)).toString(),console.log(e.newAdForm.categoryChild)}),e.loadingBufferData=!1},()=>{console.log("fail"),e.loadingBufferData=!1})}),e.uploadAndSaveRedis=(()=>{e.newAdForm.files&&e.newAdForm.files.length>0?e.uploadFiles(e.newAdForm.files,!0):e.saveAdToRedis(null,null)}),e.uploadAndSaveMongo=(()=>{e.uploadFiles(e.newAdForm.files,!1)}),e.nextLoader=!1,e.uploading=!1,e.photos=[],e.uploadFiles=((o,r)=>{if(e.nextLoader=!0,e.uploading=!0,o&&o.length){let n=0;angular.forEach(o,a=>{let i=s()+"_"+a.name;a.upload=t.upload({url:"https://easyad-static.s3-eu-central-1.amazonaws.com",method:"POST",data:{key:i,acl:e.acl,policy:e.policy,"X-amz-signature":e.X_amz_signature,"X-amz-credential":e.x_amz_credential,"X-amz-algorithm":e.X_amz_algorithm,"X-amz-date":e.X_amz_date,"Content-Type":""!=a.type?a.type:"application/octet-stream",filename:a.name,file:a}}),a.upload.then(t=>{e.result=t.data,a.progressFinish=!0,n++,a.showcase?e.photos.push({filename:i,showcase:!0}):e.photos.push({filename:i}),n===o.length&&(e.uploading=!1,r?e.saveAdToRedis(e.photos):e.onSubmitAd(e.photos))},t=>{t.status>0&&(e.errorMsg=t.status+": "+t.data)},e=>{a.progress=Math.min(100,parseInt(100*e.loaded/e.total))})})}}),e.saveAdToRedis=(t=>{e.newAdBtnLoading=!0;let o,n={data:e.newAdForm,photos:t};try{o=e.countries[e.newAdForm.country].cities[e.newAdForm.city].districts[e.newAdForm.district]._id}catch(e){o=null}let a;try{a=e.categories[e.newAdForm.category].subCategories[e.newAdForm.categoryChild]._id}catch(e){a=null}r({url:"/newAd/saveAdRedis",method:"POST",data:{data:n,country:{country:{id:e.countries[e.newAdForm.country]._id,index:e.newAdForm.country},city:{id:e.countries[e.newAdForm.country].cities[e.newAdForm.city]._id,index:e.newAdForm.city},district:{id:o,index:e.newAdForm.district}},category:{category:{id:e.categories[e.newAdForm.category]._id,index:e.newAdForm.category},childCategory:{id:a,index:e.newAdForm.categoryChild}}}}).then(t=>{e.newAdBtnLoading=!1,1===t.data.status&&c()},()=>{console.log("fail")})}),e.adSaveComplete=!1,e.submitBtnLoading=!1,e.onSubmitAd=(t=>{e.submitBtnLoading=!0;let o=Object.assign({},e.newAdForm);delete o.files;let a=t?t.concat(d):null,i=a.findIndex(e=>!0===e.showcase);console.log(t),console.log(a);let s;try{s=e.countries[e.newAdForm.country].cities[e.newAdForm.city].districts[e.newAdForm.district]._id}catch(e){s=null}let c;try{c=e.categories[e.newAdForm.category].subCategories[e.newAdForm.categoryChild]._id}catch(e){c=null}r({url:"/newAd/create",method:"POST",data:{data:o,power:{powerStatus:e.buyPowerStatus,powerNumber:e.powerNumber},photos:a,showcaseIndex:i,country:{countryId:e.countries[e.newAdForm.country]._id,cityId:e.countries[e.newAdForm.country].cities[e.newAdForm.city]._id,districtId:s},category:{categoryId:e.categories[e.newAdForm.category]._id,childCategoryId:c}}}).then(t=>{e.submitBtnLoading=!1,1===t.data.status&&(e.adSaveComplete=!0,n.scrollTo(0,0))},()=>{e.submitBtnLoading=!1,console.log("fail")})}),e.newAdForm.showcaseIndex=0,e.onPhotoSelect=(()=>{e.newAdForm.files.length>0&&(e.newAdForm.files[e.newAdForm.showcaseIndex].showcase=!0)}),e.onDeletePhoto=(t=>{e.newAdForm.files.splice(t,1),e.newAdForm.showcaseIndex===t&&(e.newAdForm.files[0].showcase=!0,e.newAdForm.showcaseIndex=0)}),e.onSelectShowCase=(t=>{e.newAdForm.files[e.newAdForm.showcaseIndex].showcase=!1,e.newAdForm.showcaseIndex=t,e.newAdForm.files[t].showcase=!0}),e.triggerUploadWindow=(()=>{$('input[type="file"]').trigger("click")});let c=()=>{e.openSignInModal(),e.powerTab(),e.nextLoader=!1};e.previewTab=(()=>{e.steps.informations=!1,e.steps.power=!1,e.steps.preview=!0}),e.powerTab=(()=>{e.steps.informations=!1,e.steps.power=!0,e.steps.preview=!1}),e.adInformationTab=(()=>{e.steps.informations=!0,e.steps.power=!1,e.steps.preview=!1})}]);