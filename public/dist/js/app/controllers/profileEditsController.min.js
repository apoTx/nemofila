app.controller("profileEditsController",["$scope","Upload","$timeout","$http","$window","newAdFactory","countriesFactory","categoriesFactory","config","Slug",(e,o,t,a,n,r,d,s,i,l)=>{function c(){function e(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}return e()+e()+"-"+e()+"-"+e()+"-"+e()+"-"+e()+e()+e()}e.newAdForm={},e.newAdForm.anotherContact={},e.steps={},e.steps.informations=!0,e.steps.power=!1,e.steps.preview=!1,e.powerNumber="0",e.buyPowerStatus=!1,e.buyPowerLoader=!1,e.newAdForm.place=null,e.autocompleteOptions={types:["(cities)"]},e.next=(()=>{e.previewTab(),e.$apply()}),e.back=(()=>{e.adInformationTab()}),e.uploadedFiles=[],e.getAd=((o,t)=>{e.loadingBufferData=!0,a({url:"/newAd/getEditAd/"+o,method:"GET"}).then(o=>{e.newAdForm.title=o.data.title||"",e.newAdForm.description=o.data.description||"",e.newAdForm.description2=o.data.description2||"",e.newAdForm.phone=o.data.phone||"",e.newAdForm.mobile_phone=o.data.mobile_phone||"",e.newAdForm.address=o.data.address||"",e.newAdForm.website=o.data.website||"",e.newAdForm.anotherContact=o.data.anotherContact,e.newAdForm.place=o.data.place,e.newAdForm.workTimes=o.data.workTimes,e.newAdForm.anotherContact||(e.newAdForm.anotherContact={},e.newAdForm.anotherContact.checked=!1);try{e.newAdForm.files=o.data.photos||"",e.uploadedFiles=e.newAdForm.files,e.newAdForm.showcaseIndex=o.data.photoShowcaseIndex}catch(o){e.newAdForm.files=[]}let a=o.data.category;setTimeout(()=>{e.newAdForm.category=e.categories.findIndex(e=>String(e._id)===String(a.categoryId)).toString(),e.newAdForm.categoryChild=e.categories[e.newAdForm.category].subCategories.findIndex(e=>String(e._id)===String(a.categoryChildId)).toString()}),e.loadingBufferData=!1,t()},()=>{console.log("fail"),e.loadingBufferData=!1})}),e.uploadAndSaveMongo=(o=>{e.newAdForm.files&&e.newAdForm.files.length>0?e.uploadFiles(e.newAdForm.files,o):e.onSubmitAd(null,o,!1)}),e.nextLoader=!1,e.uploading=!1,e.photos=[],e.uploadFiles=((t,a)=>{e.nextLoader=!0,e.uploading=!0,t&&t.length&&(t.filter(e=>e.name).length<1&&(e.uploading=!1,e.onSubmitAd(t,a,!1)),t.forEach((t,a)=>{let n=t.name.split("."),r=n[n.length-1],d=c()+"."+r;t.upload=o.upload({url:i.s3_upload_url,method:"POST",data:{key:d,acl:e.acl,policy:e.policy,"X-amz-signature":e.X_amz_signature,"X-amz-credential":e.x_amz_credential,"X-amz-algorithm":e.X_amz_algorithm,"X-amz-date":e.X_amz_date,"Content-Type":""!=t.type?t.type:"application/octet-stream",filename:d,file:t}}),t.upload.then(o=>{e.result=o.data,e.uploading=!1},o=>{o.status>0&&(e.errorMsg=o.status+": "+o.data)},e=>{t.progress=Math.min(100,parseInt(100*e.loaded/e.total))})}))}),e.adSaveComplete=!1,e.submitBtnLoading=!1,e.onSubmitAd=((o,t,r)=>{e.submitBtnLoading=!0;let d=Object.assign({},e.newAdForm);delete d.files;let s;!1===r?s=o:e.uploadedFiles?(console.log("test"),s=o?o.concat(e.uploadedFiles):null):s=o;let i;try{i=s.findIndex(e=>!0===e.showcase)}catch(e){i=null}let l;try{l=e.categories[e.newAdForm.category].subCategories[e.newAdForm.categoryChild]._id}catch(e){l=null}let c="false"!==t;a({url:"/newAd/create",method:"POST",data:{recaptcha:document.getElementById("g-recaptcha-response").value,data:d,isEdit:c,editId:t,power:{powerStatus:e.buyPowerStatus,powerNumber:e.powerNumber},photos:s,showcaseIndex:i,category:{categoryId:e.categories[e.newAdForm.category]._id,childCategoryId:l}}}).then(o=>{e.submitBtnLoading=!1,1===o.data.status&&(e.adSaveComplete=!0,n.scrollTo(0,0))},()=>{e.submitBtnLoading=!1,console.log("fail")})}),e.newAdForm.showcaseIndex=0,e.onPhotoSelect=(()=>{e.isEdit?e.uploadedFiles<1&&(e.newAdForm.files[0].showcase=!0):e.newAdForm.files.length>0&&(e.newAdForm.files[e.newAdForm.showcaseIndex].showcase=!0)}),e.onDeletePhoto=(o=>{e.newAdForm.files.splice(o,1),e.newAdForm.showcaseIndex===o&&(e.newAdForm.files[0].showcase=!0,e.newAdForm.showcaseIndex=0)}),e.onSelectShowCase=(o=>{e.newAdForm.files[e.newAdForm.showcaseIndex].showcase=!1,e.newAdForm.showcaseIndex=o,e.newAdForm.files[o].showcase=!0}),e.triggerUploadWindow=(()=>{$('input[type="file"]').trigger("click")}),e.previewTab=(()=>{e.steps.informations=!1,e.steps.power=!1,e.steps.preview=!0,n.scrollTo(0,0)}),e.powerTab=(()=>{e.steps.informations=!1,e.steps.power=!0,e.steps.preview=!1,n.scrollTo(0,0)}),e.adInformationTab=(()=>{e.steps.informations=!0,e.steps.power=!1,e.steps.preview=!1,n.scrollTo(0,0)}),e.activeSaveBtn=!1,e.successCaptcha=(()=>{e.activeSaveBtn=!0})}]);