app.controller("messagesController",["$scope","$rootScope","messageFactory","$routeParams",function(e,s,a,n){function t(){setTimeout(()=>{o.scrollTop=o.scrollHeight},1)}let o=document.getElementById("messageList");e.sendMessageFormData={},e.loadingMessages=!1,e.loadingConversations=!0,a.getConversations().then(s=>{if(e.loadingConversations=!1,e.conversations=s,n.id){let s=e.conversations.find(e=>String(e._id)===String(n.id)).ad;e.ad.title=s.title,e.ad.price=s.price,e.ad.slug=s.slug,e.ad.id=s._id,e.ad.showcasePhoto=s.photos[s.photoShowcaseIndex].filename}}),e.ad={},n.id&&(e.sendMessageFormData.conversationId=n.id,e.visibleMessages=!0,e.loadingMessages=!0,a.getMessages(n.id).then(o=>{e.loadingMessages=!1,e.messages=o.data,e.sendMessageFormData.toUserId=o.toUserId,t(),a.markAsRead(n.id,e.sendMessageFormData.toUserId).then(()=>{a.getUnreadMessages().then(e=>{s.messageLength=e.length})})})),e.messageSended=!1,e.sendMessage=(()=>{e.sendMessageLoading=!0,a.createMessage(e.sendMessageFormData,e.sendMessageFormData.conversationId).then(s=>{if(e.sendMessageLoading=!1,1!==s.status)return e.sendMessageErr=s.error,!1;e.messages.push({message:e.sendMessageFormData.message,createdAt:new Date,user:{name:e.sendMessageFormData.username,surname:e.sendMessageFormData.surname}}),e.sendMessageFormData.message="",t()})})}]);